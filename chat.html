<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Project 3</title>

    <!-- Link to style sheet -->
    <link rel="stylesheet" type="text/css" href="style.css">

    <!-- Link to web font -->
    <link href="https://fonts.googleapis.com/css?family=Dosis:400,500" rel="stylesheet" type="text/css">

    <!-- Link to jquery -->
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js"></script>

    <!-- Chat Bot -->
    <script type="text/javascript">
        "use strict";
        // api.ai token and url
        var accessToken = "427fba490ee242f5b6081ce0fd8bd27a",
            baseUrl = "https://api.api.ai/v1/";

        // giphy api token
        var giphyToken = "dc6zaTOxFJmzC";

        // writes to chatbox once content comes from api and user sends content
        function writeToChatbox(sender, message) {
            var chatbox = $("#chatbox");
            var start = chatbox[0].innerHTML;

            // new lines
            if (start.length > 0) {
                start += "<br>";
            }
            // if it's a giphy put it in an image tag
            // search the url to check if giphy
            if (message.indexOf("giphy") >= 0 && message.indexOf("http") >= 0) {
                start += sender + ": ";
                chatbox[0].innerHTML = start + '<img src=" '+message+' \n" />';
            }
            // otherwise just send as text
            else {
                start += sender + ": ";
                chatbox[0].innerHTML = start + message;
            }
            
        }

        // message received 
        function messageReceived(text) {
            var chatbox = $("#chatbox");
            console.log("Received " + text);
            //writeToChatbox("Chatbot", text);
        }

        // sends to apis 
        function send(text) {
            console.log(JSON.stringify({ query: text, lang: "en", sessionId: "stealth" }));
            var chatbox = $("#chatbox");
            writeToChatbox("You", text);
            console.log("Sending " + text);
            // post requirements for api.ai
            $.ajax({
                type: "POST",
                url: baseUrl + "query",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                beforeSend: function (request) {
                    request.setRequestHeader("Authorization", "Bearer " + accessToken);
                },
                data: JSON.stringify({ query: text, lang: "en", sessionId: "stealth", v: 20150910 }),
                success: function (data) {
                    // prepareResponse(data);
                    console.log(data.result.speech);
                    writeToChatbox("Stella", data.result.speech);
                },
                // debgugging... did something go wrong?
                error: function () {
                    console.log("meep");
                }
            });

            // timer for response from stella
            window.setTimeout(function () {
                messageReceived(text);
            }, 500);
        }

        // send on enter 
        document.onkeydown = function () {
            if (window.event.keyCode == '13') {
                submit();
            }
        }

        // submit user message and send content to send function
        function submit(event) {
            var inputbox = $('#usermsg');
            var message = inputbox.val();
            send(message);
            inputbox.val("");
        }

        // send giphy from user to send function
        function sendGiphy(url) {
            var inputbox = $('#usermsg');
            var message = url;
            send(message);
            inputbox.val("");
            giphySearch("");
        }

        // search for gif by pressing the button
        function giphyButton(event) {
            var inputbox = $('#usermsg');
            var message = inputbox.val();
            //giphyUrl = "http://api.giphy.com/v1/gifs/search?q=" + message + "&api_key=dc6zaTOxFJmzC";
            giphySearch(message);
            inputbox.val("");
        }

        // giphy search and giphy api requests 
        function giphySearch(text) {
            console.log(text);
            // post req
            $.ajax({
                type: "GET",
                url: "https://api.giphy.com/v1/gifs/search?q=" + text + "&api_key=dc6zaTOxFJmzC",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data) {
                    // concatenate each image url from api into an image tag that loads into the html
                    var html = "";
                    for(var i = 0; i < data.data.length; i++) {
                        html += '<img src="'+data.data[i].images.fixed_height_small.url+'" onclick="sendGiphy(\''+data.data[i].images.fixed_height_small.url+'\')" />';
                    }
                    document.getElementById("giphyImages").innerHTML = html;
                    console.log(data.data[i].images.fixed_height_small.url);

                },
                // dubugging if something goes wrong
                error: function () {
                    console.log("meep");
                }
            });
        }

        // jQuery Document
        $(document).ready(function () {
        });

    </script>

</head>

<body>
    <div id="heading">
        <h2>Welcome to Stella, your personal assistant!</h2>
        <img src="giphy.png">
        <h3>(c) Sneha Vaswani and Sam Heckle</h3>
    </div>
    <div id="chatbox"></div>

    <!--<form name="message" action="">
            <input name="usermsg" type="text" id="usermsg" size="63" />
            <input name="submitmsg" type="submit"  id="submitmsg" value="Send" />
        </form>-->
    <div id="userInput">
        <input name="usermsg" type="text" id="usermsg" size="63" />
        <button id="giphybutton" onclick="giphyButton()">Giphy</button>
        <button id="submitmsg" onclick="submit()">Send</button>
    </div>
    <div id="giphyImages">

    </div>
</body>

</html>